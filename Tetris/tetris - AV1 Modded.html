<!-- Ajustes no canvas e background -->
<style>
    body{
        background: #202028;
        color: #ffffff;
        text-align: center;
    }
    canvas{
        border: solid #fff;
        height: 90vh;
    }
</style>
<div id="score"></div>
<div id="level"></div>
<canvas id="tela" width="300" height="600"></canvas>
<script>
/*
   Jogo: Tetris
   Autor: Code Explained (www.codeexplained.org)
   Adaptado por: Gilson Filho 
   Modded by: Parjasnelly A. e Samuel Maia
   v 2.0 
*/

// Rotina principal

const I = [
	[
		[0, 0, 0, 0],
		[1, 1, 1, 1],
		[0, 0, 0, 0],
		[0, 0, 0, 0],
	],
	[
		[0, 0, 1, 0],
		[0, 0, 1, 0],
		[0, 0, 1, 0],
		[0, 0, 1, 0],
	],
	[
		[0, 0, 0, 0],
		[0, 0, 0, 0],
		[1, 1, 1, 1],
		[0, 0, 0, 0],
	],
	[
		[0, 1, 0, 0],
		[0, 1, 0, 0],
		[0, 1, 0, 0],
		[0, 1, 0, 0],
	]
];

const J = [
	[
		[1, 0, 0],
		[1, 1, 1],
		[0, 0, 0]
	],
	[
		[0, 1, 1],
		[0, 1, 0],
		[0, 1, 0]
	],
	[
		[0, 0, 0],
		[1, 1, 1],
		[0, 0, 1]
	],
	[
		[0, 1, 0],
		[0, 1, 0],
		[1, 1, 0]
	]
];

const L = [
	[
		[0, 0, 1],
		[1, 1, 1],
		[0, 0, 0]
	],
	[
		[0, 1, 0],
		[0, 1, 0],
		[0, 1, 1]
	],
	[
		[0, 0, 0],
		[1, 1, 1],
		[1, 0, 0]
	],
	[
		[1, 1, 0],
		[0, 1, 0],
		[0, 1, 0]
	]
];

const O = [
	[
		[0, 0, 0, 0],
		[0, 1, 1, 0],
		[0, 1, 1, 0],
		[0, 0, 0, 0],
	]
];

const S = [
	[
		[0, 1, 1],
		[1, 1, 0],
		[0, 0, 0]
	],
	[
		[0, 1, 0],
		[0, 1, 1],
		[0, 0, 1]
	],
	[
		[0, 0, 0],
		[0, 1, 1],
		[1, 1, 0]
	],
	[
		[1, 0, 0],
		[1, 1, 0],
		[0, 1, 0]
	]
];

const T = [
	[
		[0, 1, 0],
		[1, 1, 1],
		[0, 0, 0]
	],
	[
		[0, 1, 0],
		[0, 1, 1],
		[0, 1, 0]
	],
	[
		[0, 0, 0],
		[1, 1, 1],
		[0, 1, 0]
	],
	[
		[0, 1, 0],
		[1, 1, 0],
		[0, 1, 0]
	]
];

const Z = [
	[
		[1, 1, 0],
		[0, 1, 1],
		[0, 0, 0]
	],
	[
		[0, 0, 1],
		[0, 1, 1],
		[0, 1, 0]
	],
	[
		[0, 0, 0],
		[1, 1, 0],
		[0, 1, 1]
	],
	[
		[0, 1, 0],
		[1, 1, 0],
		[1, 0, 0]
	]
];

const PECAS = [
    [Z, "#FFE138"],
    [S, "#FF8E0D"],
    [T, "#FF0D72"],
    [O, "#F538FF"],
    [L, "#0DFF72"],
    [I, "#3877FF"],
    [J, "#0DC2FF"]
];

const LINHA = 20;
const COLUNA = 10;
const TAMANHO = 30;
const VAGO = "black";

var peca;
var tabuleiro = [];

var inicioDescida;
var tempoDescida = 1000;
var fimDeJogo = false;
var scores = 0;
var level = 1;
var linhasCheias = 0;
var lCTotal = 0;
var tela = document.getElementById("tela");
var c = tela.getContext("2d");

onkeydown = controlarPeca;

iniciarTabuleiro();

desenharTabuleiro();

gerarPeca();

inicioDescida = Date.now();

descerPeca();


// Sub-rotinas (funções)

function iniciarTabuleiro() {
	for (var i = 0; i < LINHA; i++) {
		tabuleiro[i] = [];
		
		for (var j = 0; j < COLUNA; j++) {
			tabuleiro[i][j] = VAGO;
		}
	}
}

function desenharTabuleiro(){
    for (var i = 0; i < LINHA; i++) {
        for (var j = 0; j < COLUNA; j++) {
            desenharQuadrado(j, i, tabuleiro[i][j]);
        }
    }
}

function desenharQuadrado(x, y, cor){
    if(fimDeJogo){
        // escreve o game over
        c.font = "30px Comic Sans MS";
        c.fillStyle = "white";
        c.textAlign = "center";
        c.strokeText("Game over!", tela.width/2, tela.height/2);
        c.fillText("Game over!", tela.width/2, tela.height/2);
    }
    // exibe os scroes(provisório)
    document.getElementById('score').innerText = scores;
    document.getElementById('level').innerText = level;


    c.fillStyle = cor;

    c.fillRect(x*TAMANHO, y*TAMANHO, TAMANHO, TAMANHO);

    c.strokeStyle = "black";
    c.strokeRect(x*TAMANHO, y*TAMANHO, TAMANHO, TAMANHO);
}

function gerarPeca(){
    var r = Math.floor(Math.random() * PECAS.length);
	
	peca = {
		tetramino : PECAS[r][0],
		cor : PECAS[r][1],
		tetraminoN : 0,
		tetraminoAtivo : [[]],
		x : 3,
		y : -2
	};
	
	peca.tetraminoAtivo = peca.tetramino[peca.tetraminoN];
}

function descerPeca(){
    var agora = Date.now();
    var delta = agora - inicioDescida;
	//tempo de descida com variavel
    if (delta > tempoDescida-level) {
        moverAbaixo();
        inicioDescida = Date.now();
    }
	
    if (!fimDeJogo) {
        requestAnimationFrame(descerPeca);
    }
}

function moverAbaixo(){
    if (!colisao(0, 1, peca.tetraminoAtivo)) {
        apagarPeca();
        peca.y++;
        desenharPeca();
    } else {
        travarPeca();
        gerarPeca();
    }
    
}

function moverDireita(){
    if (!colisao(1, 0, peca.tetraminoAtivo)) {
        apagarPeca();
        peca.x++;
        desenharPeca();
    }
}

function moverEsquerda(){
    if (!colisao(-1, 0, peca.tetraminoAtivo)) {
        apagarPeca();
        peca.x--;
        desenharPeca();
    }
}

function colisao(x, y, p){
    for (var i = 0; i < p.length; i++) {
        for (var j = 0; j < p.length; j++) {
            if (!p[i][j]) {
                continue;
            }
			
            var novoX = peca.x + j + x;
            var novoY = peca.y + i + y;
			
            if (novoX < 0 || novoX >= COLUNA || novoY >= LINHA) {
                return true;
            }
			
            if (novoY < 0) {
                continue;
            }
			
            if (tabuleiro[novoY][novoX] != VAGO) {
                return true;
            }
        }
    }
	
    return false;
}

function apagarPeca(){
    preencherPeca(VAGO);
}

function desenharPeca(){
    preencherPeca(peca.cor);
}

function preencherPeca(cor) {
    for (var i = 0; i < peca.tetraminoAtivo.length; i++) {
        for (var j = 0; j < peca.tetraminoAtivo.length; j++) {
            if (peca.tetraminoAtivo[i][j]) {
                desenharQuadrado(peca.x + j, peca.y + i, cor);
            }
        }
    }
}

function travarPeca(){
    for (var i = 0; i < peca.tetraminoAtivo.length; i++) {
        for (var j = 0; j < peca.tetraminoAtivo.length; j++) {
            if (!peca.tetraminoAtivo[i][j]) {
                continue;
            }

            if (peca.y + i < 0) {
                fimDeJogo = true;
                break;
            }

            tabuleiro[peca.y+i][peca.x+j] = peca.cor;
        }
    }

    for (var i = 0; i < LINHA; i++) {
        var linhaCheia = true;

        for (var j = 0; j < COLUNA; j++) {
            linhaCheia = linhaCheia && (tabuleiro[i][j] != VAGO);
        }

     if(linhaCheia){
         linhasCheias++
     }
    }
    if(linhasCheias==1){
        scores+=(100*level);
    }
    if(linhasCheias==2){
        scores+=(300*level);
    }
    if(linhasCheias==3){
        scores+=(500*level);
    }
    if(linhasCheias==4){
        scores+=(800*level);
    }
    lCTotal += linhasCheias;
    linhasCheias=0;
    if(lCTotal>=10){
        level++
        lCTotal-=10;
    }
    for (var i = 0; i < LINHA; i++) {
        var linhaCheia = true;

        for (var j = 0; j < COLUNA; j++) {
            linhaCheia = linhaCheia && (tabuleiro[i][j] != VAGO);
        }


        if (linhaCheia) {
            for (var y = i; y > 1; y--) {
                for (var j = 0; j < COLUNA; j++) {
                    tabuleiro[y][j] = tabuleiro[y-1][j];
                }
            }

            for (var j = 0; j < COLUNA; j++) {
                tabuleiro[0][j] = VAGO;
            }
        }
    }

    desenharTabuleiro();
}

function rodarPeca(){
    var proximoPadrao = peca.tetramino[(peca.tetraminoN + 1) % peca.tetramino.length];
    var recuo = 0;
    
    if (colisao(0, 0, proximoPadrao)) {
        if (peca.x > COLUNA/2) {
            recuo = -1;
        } else {
            recuo = 1;
        }
    }
    
    if (!colisao(recuo, 0, proximoPadrao)) {
        apagarPeca();
        peca.x += recuo;
        peca.tetraminoN = (peca.tetraminoN + 1) % peca.tetramino.length;
        peca.tetraminoAtivo = peca.tetramino[peca.tetraminoN];
        desenharPeca();
    }
}

function controlarPeca(evento) {
    var tecla = evento.keyCode;
    //BugFix: Adicionado uma condição para que não se possa controlar a peça mesmo após o fim de jogo
    if (!fimDeJogo) {
        if (tecla == 37) {
            moverEsquerda();
            inicioDescida = Date.now();
        } else if (tecla == 38) {
            rodarPeca();
            inicioDescida = Date.now();
        } else if (tecla == 39) {
            moverDireita();
            inicioDescida = Date.now();
        } else if (tecla == 40) {
            moverAbaixo();
            //bonus de pontos para a descida acelerada
            scores++;
        }
    }
}
</script>